<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exchange VN</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="light-theme">
  <div id="app">
    <div id="loading">Загрузка...</div>
    <div id="user-view" class="hidden"></div>
    <div id="admin-view" class="hidden"></div>
  </div>
  <script>
    (async () => {
      const initData = Telegram.WebApp.initData || '';
      const theme = Telegram.WebApp.colorScheme;
      document.body.className = theme === 'dark' ? 'dark-theme' : 'light-theme';

      const res = await fetch('/api/init', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ initData })
      });
      const data = await res.json();

      document.getElementById('loading').classList.add('hidden');

      if (data.isAdmin) {
        renderAdmin(data.settings);
      } else {
        renderUser(data.user, data.settings);
      }
    })();

    function renderUser(user, settings) {
      const el = document.getElementById('user-view');
      if (settings.isHoliday) {
        el.innerHTML = `<div class="card">❌ Сегодня выходной. Обмен временно недоступен.</div>`;
        el.classList.remove('hidden');
        return;
      }

      el.innerHTML = `
        <div class="card">
          ${user.photo_url ? `<img src="${user.photo_url}" width="60" height="60" style="border-radius:50%">` : ''}
          <h2>Привет, ${user.first_name}!</h2>
          <p>Выберите город:</p>
          <select id="city">
            <option>Нячанг</option>
            <option>Хошимин</option>
            <option>Фукок</option>
            <option>Дананг</option>
            <option>Ханой</option>
          </select>
          <button onclick="nextStep()">Далее</button>
        </div>
      `;
      el.classList.remove('hidden');
    }

    function nextStep() {
      const city = document.getElementById('city').value;
      const directions = [
        { id: 'RUB_VND', label: 'Рубли (карта) → Донги (нал)' },
        { id: 'USD_VND', label: 'Доллар (нал) → Донги (нал)' },
        { id: 'USDT_VND', label: 'USDT → Донги (нал)' },
        { id: 'VndToRub', label: 'Донги (нал) → Рубли (карта)' },
        { id: 'VndToUsd', label: 'Донги (нал) → Доллар (нал)' },
        { id: 'VndToUsdt', label: 'Донги (нал) → USDT' }
      ];

      document.getElementById('user-view').innerHTML = `
        <div class="card">
          <h3>Направление обмена:</h3>
          <select id="dir">
            ${directions.map(d => `<option value="${d.id}">${d.label}</option>`).join('')}
          </select>
          <button onclick="showAmount('${city}')">Продолжить</button>
        </div>
      `;
    }

    function showAmount(city) {
      const dirMap = {
        'RUB_VND': 'RUB_VND',
        'USD_VND': 'USD_VND',
        'USDT_VND': 'USDT_VND',
        'VndToRub': 'VND_RUB',
        'VndToUsd': 'VND_USD',
        'VndToUsdt': 'VND_USDT'
      };
      const dirKey = document.getElementById('dir').value;
      const fullKey = `${city}_${dirMap[dirKey]}`;
      
      const rateInfo = {
        min: 5000,
        max: 500000,
        rate: 310
      };

      document.getElementById('user-view').innerHTML = `
        <div class="card">
          <p>Курс: 1 = ${rateInfo.rate} VND</p>
          <p>Сумма от ${rateInfo.min} до ${rateInfo.max}</p>
          <input type="number" id="amount" placeholder="Введите сумму" min="${rateInfo.min}" max="${rateInfo.max}">
          <button onclick="contactOperator('${city}', '${document.getElementById('dir').options[document.getElementById('dir').selectedIndex].text}')">Обменять</button>
        </div>
      `;
    }

    function contactOperator(city, direction) {
      const amount = document.getElementById('amount').value;
      if (!amount) return alert('Введите сумму');
      const msg = encodeURIComponent(
        `Здравствуйте! Хочу совершить обмен.\nНаправление: ${direction}\nСумма: ${amount}\nГород: ${city}`
      );
      Telegram.WebApp.openTelegramLink('https://t.me/exchange_vn_support?text=' + msg);
    }

    function renderAdmin(settings) {
      const el = document.getElementById('admin-view');
      el.innerHTML = `
        <div class="card">
          <h2>Админ-панель</h2>
          <label>Оператор (@username):</label>
          <input type="text" id="op" value="${settings.operatorUsername}">
          <label><input type="checkbox" id="holiday" ${settings.isHoliday ? 'checked' : ''}> Выходной</label>
          <button onclick="saveAdmin()">Сохранить</button>
        </div>
      `;
      el.classList.remove('hidden');
    }

    async function saveAdmin() {
      const newSettings = {
        operatorUsername: document.getElementById('op').value,
        isHoliday: document.getElementById('holiday').checked,
        rates: {}
      };

      const res = await fetch('/api/save-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ initData: Telegram.WebApp.initData, newSettings })
      });
      if (res.ok) alert('Сохранено!');
    }
  </script>
</body>
</html>